<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Shopping Cart — Zama FHEVM</title>
  <style>
    :root{
      --bg:#0b1220;--card:#111a2b;--text:#e6f0ff;--muted:#94a3b8;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;
      --bd:#223049;--br:16px;--shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#0e1730,#0b1220);color:var(--text);font:16px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1080px;margin:26px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{font-weight:800;letter-spacing:.2px}
    .logo span{color:#22d3ee}
    .badge{background:rgba(255,255,255,.04);border:1px solid var(--bd);color:#cfe3ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .btn{background:#1b2b49;border:1px solid #2a3c63;color:#dceafe;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:#20345a}
    .btn.accent{background:#1f2d46;border-color:#35507c}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--br);padding:16px;box-shadow:var(--shadow)}
    label{display:block;color:var(--muted);font-weight:600;margin-bottom:6px}
    input,select{width:100%;background:#0f172a;border:1px solid #24385f;border-radius:12px;padding:10px 12px;color:#dbeafe;outline:none}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
    .status{margin-top:8px;color:#9fb3cc;font-size:13px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px dashed #37517d;color:#bcd1ff;font-size:12px}
    pre{background:#0c1428;border:1px dashed #274369;border-radius:12px;padding:10px;white-space:pre-wrap;word-break:break-word;color:#cfe3ff}
    .meter{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#0e1a33;border:1px solid #28406a;border-radius:12px;padding:6px 10px;color:#98b7ff}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
  </style>
</head>
<body>
<main class="wrap">
  <header>
    <h1 class="logo">Private <span>Cart</span></h1>
    <span id="netBadge" class="badge">Network: —</span>
    <span id="ctrBadge" class="badge">Contract: —</span>
    <button id="connectBtn" class="btn primary" style="margin-left:auto">Connect Wallet</button>
  </header>

  <div class="grid">
    <!-- Left: user -->
    <section class="card">
      <h3>Submit encrypted item</h3>
      <div class="kv"><label>Cart key (any text)</label><input id="cartKey" placeholder="e.g. my-cart-42"/></div>
      <div class="kv"><label>Price (uint64, cents)</label><input id="price" type="number" min="0" placeholder="e.g. 2499"/></div>
      <div class="kv">
        <label>Category</label>
        <select id="category">
          <option value="0">0 — Food</option>
          <option value="1">1 — Electronics</option>
          <option value="2">2 — Books</option>
          <option value="3">3 — Fashion</option>
          <option value="4">4 — Home</option>
          <option value="5">5 — Beauty</option>
          <option value="6">6 — Sports</option>
          <option value="7">7 — Other</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="addBtn" class="btn accent">Add Encrypted Item</button>
        <button id="checkOwnerBtn" class="btn">Owner?</button>
        <span id="userStatus" class="status"></span>
      </div>
      <div id="txBox" class="status"></div>

      <div style="margin-top:12px">
        <span class="pill">Aggregates only • Fully Homomorphic (Zama FHEVM)</span>
      </div>
    </section>

    <!-- Right: admin of cart -->
    <section class="card">
      <h3>Cart admin tools</h3>
      <div class="kv"><label>Cart key</label><input id="adminCartKey" placeholder="same as left"/></div>
      <div class="row" style="margin-top:8px">
        <button id="initBtn" class="btn">Init/Reset Cart</button>
        <button id="makePublicBtn" class="btn">Make Aggregates Public</button>
        <span id="adminStatus" class="status"></span>
      </div>

      <h4 style="margin-top:14px">Handles (for audit)</h4>
      <div class="meter">
        <span class="chip">total: <span id="hTotal">—</span></span>
      </div>
      <pre id="hCats">cats: —</pre>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h3>Read aggregates</h3>
    <div class="kv"><label>Cart key</label><input id="readCartKey" placeholder="same key"/></div>
    <div class="row" style="margin-top:8px">
      <button id="readBtn" class="btn">Read (publicDecrypt → userDecrypt)</button>
      <span id="readStatus" class="status"></span>
    </div>
    <div class="meter" style="margin-top:10px">
      <span class="chip">total: <b id="outTotal">—</b></span>
      <span class="chip">Food: <b id="c0">—</b></span>
      <span class="chip">Electronics: <b id="c1">—</b></span>
      <span class="chip">Books: <b id="c2">—</b></span>
      <span class="chip">Fashion: <b id="c3">—</b></span>
      <span class="chip">Home: <b id="c4">—</b></span>
      <span class="chip">Beauty: <b id="c5">—</b></span>
      <span class="chip">Sports: <b id="c6">—</b></span>
      <span class="chip">Other: <b id="c7">—</b></span>
    </div>
  </section>

  <footer class="status" style="text-align:center;margin-top:18px">
    Relayer: v0.2.0 • ethers v6 • Demo UI
  </footer>
</main>

<script type="module">
  import { BrowserProvider, Contract, getAddress, Interface, keccak256, toUtf8Bytes } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
  import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

  // ===== Config — подставьте адрес своего контракта после деплоя =====
  const CONFIG = {
    NETWORK_NAME: "Sepolia",
    CHAIN_ID_HEX: "0xaa36a7",
    CONTRACT_ADDRESS: "0x92b8Ff5402eFBFB8023Bd48771266cC58C429800",   // <— ЗАМЕНИТЕ после деплоя!
    RELAYER_URL: "https://relayer.testnet.zama.cloud",
    MAX_CATS: 8
  };

  // ===== ABI =====
  const ABI = [
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"},{"internalType":"address","name":"owner","type":"address"}],"name":"initCart","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"},{"internalType":"bytes32","name":"priceExt","type":"bytes32"},{"internalType":"bytes32","name":"catExt","type":"bytes32"},{"internalType":"bytes","name":"proof","type":"bytes"}],"name":"addItem","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"}],"name":"makeCartPublic","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"}],"name":"getTotalHandle","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"}],"name":"getCategoryHandles","outputs":[{"internalType":"bytes32[8]","name":"","type":"bytes32[8]"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"bytes32","name":"cartId","type":"bytes32"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"cartId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"owner","type":"address"}],"name":"CartInitialized","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"cartId","type":"bytes32"},{"indexed":false,"internalType":"bytes32","name":"totalHandle","type":"bytes32"}],"name":"ItemAdded","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"cartId","type":"bytes32"}],"name":"CartMadePublic","type":"event"}
  ];

  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const short = a => a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
  const cartIdOf = (key) => keccak256(toUtf8Bytes(key || ""));

  // badges
  $('#netBadge').textContent = `Network: ${CONFIG.NETWORK_NAME}`;
  $('#ctrBadge').textContent = `Contract: ${short(CONFIG.CONTRACT_ADDRESS)}`;

  // ===== state =====
  let provider, signer, address, contract, relayer;

  async function ensureConnected(){
    if(!window.ethereum) throw new Error("Install MetaMask");
    if(!provider){
      provider = new BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      const net = await provider.getNetwork();
      if (net.chainId !== 11155111n){
        await provider.send('wallet_switchEthereumChain', [{ chainId: CONFIG.CHAIN_ID_HEX }]);
      }
      signer = await provider.getSigner();
      address = await signer.getAddress();
      contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);
      $('#connectBtn').textContent = short(address);
    }
    if(!relayer){
      await initSDK();
      relayer = await createInstance({ ...SepoliaConfig, relayerUrl: CONFIG.RELAYER_URL, network: window.ethereum, debug: true });
      console.log('[Relayer] ready', relayer?.config);
    }
    return { provider, signer, address, contract, relayer };
  }

  // Encrypt (price uint64 + category uint16) → two handles + proof
  const toHex = (u8) => '0x' + Array.from(u8, b => b.toString(16).padStart(2,'0')).join('');
  async function encryptItem(contractAddr, userAddr, price, category){
    const enc = relayer.createEncryptedInput(getAddress(contractAddr), getAddress(userAddr));
    if (typeof enc.add64 === 'function') enc.add64(BigInt(price));
    else enc.addUint64(BigInt(price));
    if (typeof enc.add16 === 'function') enc.add16(BigInt(category));
    else enc.addUint16(BigInt(category));
    const { handles, inputProof } = await enc.encrypt();
    const h0 = typeof handles[0] === 'string' ? handles[0] : toHex(handles[0]);
    const h1 = typeof handles[1] === 'string' ? handles[1] : toHex(handles[1]);
    const proof = typeof inputProof === 'string' ? (inputProof.startsWith('0x') ? inputProof : '0x'+inputProof) : toHex(inputProof);
    return { priceHandle: h0, catHandle: h1, proof };
  }

  // publicDecrypt → userDecrypt
  async function decryptMany(handles) {
    const ca = getAddress(CONFIG.CONTRACT_ADDRESS);
    // 1) попробуем publicDecrypt
    try{
      const out = await relayer.publicDecrypt(handles.map(h=>({handle:h, contractAddress:ca})));
      const vals = handles.map(h => BigInt(out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===h.toLowerCase())]));
      return vals;
    }catch(e){ console.debug('publicDecrypt failed → fallback to userDecrypt'); }

    // 2) userDecrypt (EIP-712)
    const kp = await generateKeypair();
    const startTs = Math.floor(Date.now()/1000).toString();
    const days = '7';
    const eip = relayer.createEIP712(kp.publicKey, [ca], startTs, days);
    const sig = await signer.signTypedData(eip.domain, { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification }, eip.message);

    const pairs = handles.map(h => ({ handle:h, contractAddress:ca }));
    const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig.replace(/^0x/,''), [ca], await signer.getAddress(), startTs, days);
    return handles.map(h => BigInt(out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===h.toLowerCase())]));
  }

  // === UI ===
  $('#connectBtn').addEventListener('click', async ()=>{
    try{ await ensureConnected(); } catch(e){ alert(e.message||e); }
  });

  // init/reset
  $('#initBtn').addEventListener('click', async ()=>{
    const key = $('#adminCartKey').value.trim();
    if(!key) return $('#adminStatus').textContent='Enter cart key';
    try{
      await ensureConnected();
      const id = cartIdOf(key);
      const tx = await contract.initCart(id, address);
      $('#adminStatus').textContent = 'TX: ' + tx.hash;
      await tx.wait();
      $('#adminStatus').textContent = 'Cart initialized';
    }catch(e){ $('#adminStatus').textContent = 'Error: '+(e.reason||e.message||e); }
  });

  // make public
  $('#makePublicBtn').addEventListener('click', async ()=>{
    const key = $('#adminCartKey').value.trim();
    if(!key) return $('#adminStatus').textContent='Enter cart key';
    try{
      await ensureConnected();
      const id = cartIdOf(key);
      const tx = await contract.makeCartPublic(id);
      $('#adminStatus').textContent = 'TX: ' + tx.hash;
      await tx.wait();
      $('#adminStatus').textContent = 'Aggregates made public';
    }catch(e){ $('#adminStatus').textContent = 'Error: '+(e.reason||e.message||e); }
  });

  // add encrypted item
  $('#addBtn').addEventListener('click', async ()=>{
    const key = $('#cartKey').value.trim();
    const price = $('#price').value;
    const cat = $('#category').value;
    if(!key || price==='' || +cat<0) return $('#userStatus').textContent='Fill all fields';
    try{
      await ensureConnected();
      const id = cartIdOf(key);
      $('#userStatus').textContent = 'Encrypting…';
      const { priceHandle, catHandle, proof } = await encryptItem(CONFIG.CONTRACT_ADDRESS, address, BigInt(price), BigInt(cat));
      // отправляем без estimateGas — ethers сам поставит
      const tx = await contract.addItem(id, priceHandle, catHandle, proof);
      $('#txBox').textContent = 'TX: '+tx.hash;
      await tx.wait();
      $('#userStatus').textContent = 'Added.';
    }catch(e){
      console.error(e);
      $('#userStatus').textContent = 'Error: '+(e.reason||e.message||e);
    }
  });

  // who owns cart?
  $('#checkOwnerBtn').addEventListener('click', async ()=>{
    const key = $('#cartKey').value.trim();
    if(!key) return $('#userStatus').textContent='Enter cart key';
    try{
      await ensureConnected();
      const id = cartIdOf(key);
      const owner = await contract.ownerOf(id);
      $('#userStatus').textContent = `Owner: ${short(owner)} ${owner.toLowerCase()===address.toLowerCase()?'(you)':''}`;
    }catch(e){ $('#userStatus').textContent = 'Error: '+(e.reason||e.message||e); }
  });

  // read aggregates
  $('#readBtn').addEventListener('click', async ()=>{
    const key = $('#readCartKey').value.trim();
    if(!key) return $('#readStatus').textContent='Enter cart key';
    try{
      await ensureConnected();
      const id = cartIdOf(key);
      $('#readStatus').textContent = 'Fetching handles…';
      const hTot = await contract.getTotalHandle(id);
      const hCats = await contract.getCategoryHandles(id);

      // show handles (right card mirrors this too)
      $('#hTotal').textContent = hTot;
      $('#hCats').textContent = 'cats:\n' + hCats.map((h,i)=> `${i}: ${h}`).join('\n');

      $('#readStatus').textContent = 'Decrypting…';
      const vals = await decryptMany([hTot, ...hCats]);

      const total = vals[0], cats = vals.slice(1);
      $('#outTotal').textContent = total.toString();
      for(let i=0;i<CONFIG.MAX_CATS;i++) $('#c'+i).textContent = (cats[i]??0n).toString();
      $('#readStatus').textContent = 'Done';
    }catch(e){
      console.error(e);
      $('#readStatus').textContent = 'Error: '+(e.reason||e.message||e);
    }
  });

  // convenience: mirror handles when admin key changes
  async function refreshHandlesMirror(){
    const key = $('#adminCartKey').value.trim();
    if(!key || !contract) return;
    try{
      const id = cartIdOf(key);
      const hTot = await contract.getTotalHandle(id);
      const hCats = await contract.getCategoryHandles(id);
      $('#hTotal').textContent = hTot;
      $('#hCats').textContent = 'cats:\n' + hCats.map((h,i)=> `${i}: ${h}`).join('\n');
    }catch{}
  }
  $('#adminCartKey').addEventListener('input', refreshHandlesMirror);
</script>
</body>
</html>
